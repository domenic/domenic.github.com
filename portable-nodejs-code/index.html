<!DOCTYPE html>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Portable Node.js Code</title>
<meta name="description" content="This post originally appeared as a gist, and thenon the Node on Azure blog.">

<link rel="stylesheet" href="/css/main.css">
<link rel="canonical" href="https://blog.domenic.me/portable-nodejs-code/">
<link rel="alternate" type="application/rss+xml" title="Hidden Variables" href="https://blog.domenic.me/atom.xml">



<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@domenic">
<meta property="og:title" content="Portable Node.js Code">
<meta property="og:description" content="This post originally appeared as a gist, and then
on the Node on Azure blog.

Node.js core does its best to treat every platform equally. Even if most Node developers use OS X day to day, some use
Windows, and most everyone deploys to Linux or Sol...">


<header class="site-header">
  <div class="wrapper">
    <h1 class="site-title"><a href="/">Hidden Variables</a></h1>
    <p class="tagline">Domenic's blog about coding and stuff</p>

    <nav class="site-nav">
      <a href="/archives">Archives</a>
      <a href="/atom.xml">RSS</a>
    </nav>
  </div>
</header>


<div class="page-content">
  <div class="wrapper">
    <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Portable Node.js Code</h1>
    <p class="post-meta">
      <time datetime="2012-10-02T00:00:00+00:00" itemprop="datePublished">Oct 2, 2012</time>
      
      
 | <a href="/portable-nodejs-code/#commento">Comments</a>


      | <a href="https://twitter.com/intent/tweet?text=Portable Node.js Code&amp;url=https://blog.domenic.me/portable-nodejs-code/&amp;via=domenic">Tweet</a>
      | posted in 
  <a class="category-link" href="/categories/node.js">Node.js</a>


    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p><em>This post originally appeared <a href="https://gist.github.com/domenic/2790533">as a gist</a>, and then
<a href="http://nodeblog.azurewebsites.net/how-to-write-portable-nodejs-code">on the Node on Azure blog</a>.</em></p>

<p>Node.js core does its best to treat every platform equally. Even if most Node developers use OS X day to day, some use
Windows, and most everyone deploys to Linux or Solaris. So it&rsquo;s important to keep your code portable between platforms,
whether you&rsquo;re writing a library or an application.</p>

<p>Predictably, most cross-platform issues come from Windows. Things just work differently there! But if you&rsquo;re careful,
and follow some simple best practices, your code can run just as well on Windows systems.</p>

<h2 id="paths-and-urls">Paths and URLs</h2>

<p>On Windows, paths are constructed with backslashes instead of forward slashes. So if you do your directory manipulation
by splitting on <code>&quot;/&quot;</code> and playing with the resulting array, <a href="https://github.com/logicalparadox/codex/commit/7f91b451e7cdc9d794f30bd026029aea797bb1e0">your code will fail dramatically on Windows</a>.</p>

<p>Instead, you should be using the <a href="http://nodejs.org/docs/latest/api/path.html">path module</a>. So instead of resolving paths with string contatenation, e.g.
<code>x + &quot;/&quot; + y</code>, you should instead do <code>path.resolve(x, y)</code>. Similarly, instead of relativizing paths with string
replacement, e.g. <code>x.replace(/^parent\/dirs\//, &quot;&quot;)</code>, you <a href="https://github.com/ryanmcgrath/wrench-js/commit/01190602dac64924fca2dae11912ffb560e636a0">should</a> do <code>path.relative(&quot;/parent/dirs&quot;, y)</code>.</p>

<p>Another area of concern is that, when writing portable code, you cannot count on URLs and module IDs having the same
separators as paths. If you use something like <code>path.join</code> <a href="https://github.com/domenic/knox/compare/eabef00df9bf79085229f4ed39b2679eb579ea20...9b1a4e9f644ababd5d9ced227de44709e1fccf4b">on a URL</a>, Windows users will get URLs containing
backslashes! <a href="https://github.com/isaacs/npm-www/pull/88">Similarly</a> for <code>path.normalize</code>, or in general any path methods. All this applies if you&rsquo;re
<a href="https://github.com/substack/node-browserify/pull/158">working with module IDs</a>, too: they are forward-slash delimited, so you shouldn&rsquo;t use path functions with
them either.</p>

<h2 id="non-portable-apis">Non-portable APIs</h2>

<p>Windows is completely missing the <code>process.(get|set)(gid|uid)</code> methods, so calling them will instantly crash your
program on Windows. Always <a href="https://github.com/flatiron/winston/commit/a32d92ba1be3c21859d8c1c9e8e0e701846fcaf4">guard such calls</a> with a conditional.</p>

<p>The <a href="http://nodejs.org/docs/latest/api/fs.html#fs_fs_watchfile_filename_options_listener"><code>fs.watchFile</code></a> API is not sufficiently cross-platform, and is recommended against in the docs because
of it. You <a href="https://github.com/logicalparadox/codex/commit/be2fe18f5561f7bbd3bd0099bb47f7e58c23638d">should</a> use <a href="http://nodejs.org/docs/latest/api/fs.html#fs_fs_watch_filename_options_listener"><code>fs.watch</code></a> instead.</p>

<p>The <a href="http://nodejs.org/api/child_process.html">child_process module</a> requires care cross-platform. In particular, <code>spawn</code> and <code>execFile</code> do not execute in a
shell, which means that on Windows only <code>.exe</code> files will run. This is rather problematic, as many cross-platform
binaries are included on Windows as <code>.cmd</code> or <code>.bat</code> files, <a href="https://github.com/isaacs/npm/issues/2333">among them Git</a>, <a href="https://github.com/isaacs/npm-www/blob/fd3a96e861989338676937736599598f7c0fde8f/dev/go.js#L22-27">CouchDB</a>, and
many others. So if you&rsquo;re using these APIs, things will likely work great on OS X, Linux, etc. But when you tell your
users “just install the Git build for Windows, and make sure it&rsquo;s in your path!” that ends up not being sufficient.
There is <a href="https://github.com/joyent/node/issues/2318">talk</a> of fixing this behavior in libuv, but that&rsquo;s still tentative. In the meantime, if you don&rsquo;t
need to stream your output, <code>exec</code> works well. Otherwise you&rsquo;ll need <a href="https://github.com/isaacs/npm-www/blob/fd3a96e861989338676937736599598f7c0fde8f/dev/go.js#L22-27">branching logic</a> to take care
of Windows.</p>

<p>A final edge-case comes when using named sockets, e.g. with <code>net.connect</code>. On Unix, simple filenames suffice, but on
Windows, they must conform to a <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa365783%28v=vs.85%29.aspx">bizarre syntax</a>. There&rsquo;s not really a better solution for this than
<a href="https://gist.github.com/2790533#gistcomment-331356">branching per-platform</a>.</p>

<h2 id="being-windows-developer-friendly">Being Windows-Developer Friendly</h2>

<p>One of the most egregious problems with many projects is their unnecessary use of Unix Makefiles. Windows does not have
a <code>make</code> command, so the tasks stored in these files are entirely inaccessible to Windows users who might try to
contribute to your project. This is especially annoying if you put your test command in there!</p>

<p>Fortunately, we have a solution: npm comes with a <a href="https://npmjs.org/doc/scripts.html">scripts feature</a> where you can include commands to be
run for testing (<code>test</code>), installation (<code>install</code>), building (<code>prepublish</code>), and starting your app (<code>start</code>), among many
others. You can also create custom scripts, which are then run with <code>npm run &lt;script-name&gt;</code>; I often use this for
<a href="https://github.com/domenic/sinon-chai/blob/baf878ee7ba98bae507ac8bc91c94ea1fe287964/package.json#L28">lint steps</a>. Also of note, you can reference any commands your app depends on by their short names here: for
example, <code>&quot;mocha&quot;</code> instead of <code>&quot;./node_modules/.bin/mocha&quot;</code>. So, please use these! If you must have a Makefile for
whatever reason, just have it <a href="https://github.com/LearnBoost/knox/blob/c1b680c80b7a4493970e3e9a92305387ef96c1eb/Makefile#L2-3">delegate to an npm script</a>.</p>

<p>Another crucially important step is not using Unix shell scripts as part of your development process. Windows doesn&rsquo;t
have bash, or <code>ls</code>, or <code>mv</code>, or any of those other commands you might use. Instead, write your shell scripts
<a href="http://www.2ality.com/2011/12/nodejs-shell-scripting.html">in JavaScript</a>, using a tool like <a href="http://gruntjs.com/">Grunt</a> if you&rsquo;d like.</p>

<h2 id="bonus-something-that-breaks-on-linux-and-solaris">Bonus: Something that Breaks on Linux and Solaris!</h2>

<p>Both Windows and, by default, OS X, use case-insensitive file systems. That means if you install a package named foo,
any of <code>require(&quot;foo&quot;)</code> or <code>require(&quot;FOO&quot;)</code> or <code>require(&quot;fOo&quot;)</code> will work—on Windows and OS X. But then when you go to
deploy your code, out of your development environment and into your Linux or Solaris production system, the latter two
will <em>not</em> work! So it&rsquo;s a little thing, but make sure you always get your module and package name casing right.</p>

<h2 id="conclusion">Conclusion</h2>

<p>As you can see, writing cross-platform code is sometimes painful. Usually, it&rsquo;s just a matter of best practices, like
using the path module or remembering that URLs are different from filesystem paths. But sometimes there are APIs that
just don&rsquo;t work cross-platform, or have annoying quirks that necessitate branching code.</p>

<p>Nevertheless, it&rsquo;s worth it. Node.js is the most exciting software development platform in recent memory, and one of its
greatest strengths is its portable nature. Try your best to uphold that!</p>

  </div>

</article>


  <section>
    <h1>Comments</h1>
    <div id="commento"></div>
  </section>


<script src="https://platform.twitter.com/widgets.js" async></script>

  </div>
</div>

<footer class="site-footer">
  <div class="wrapper">
    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <p>Hidden Variables</p>
        <p>Source at <a href="https://github.com/domenic/blog.domenic.me/">domenic/blog.domenic.me</a></p>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/domenic"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">domenic</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/domenic"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">domenic</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Copyright © 2020 Domenic Denicola</p>
        <p><a href="mailto:d@domenic.me">d@domenic.me</a></p>
      </div>
    </div>

  </div>
</footer>


  <script defer src="https://cdn.commento.io/js/commento.js"></script>

<script src="https://cdn.commento.io/js/count.js"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-37626687-1', 'auto');
  ga('send', 'pageview');
</script>

